<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aion 2 – Skill Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="skills-data.js"></script>
    <script>
      console.log("CLASS_SKILLS loaded:", CLASS_SKILLS);

      // Function to create skill tooltip HTML
      function createSkillTooltip(skill, currentLevel) {
        const maxLevel = skill.maxLevel || 1;
        const levelData = skill.levels
          ? skill.levels.find((l) => l.level === currentLevel) || {}
          : {};
        const description = levelData.desc || "No description available.";
        const levelPercentage = (currentLevel / maxLevel) * 100;

        return `
          <div class="skill-tooltip">
            <div class="skill-tooltip-header">
              <span class="skill-tooltip-name">${skill.name}</span>
              <span class="skill-tooltip-type">${skill.type || "active"}</span>
            </div>
            <div class="skill-tooltip-level">
              Level ${currentLevel} / ${maxLevel}
            </div>
            <div class="skill-tooltip-level-bar">
              <div class="skill-tooltip-level-fill" style="width: ${levelPercentage}%"></div>
            </div>
            <div class="skill-tooltip-desc">
              ${description}
            </div>
          </div>
        `;
      }
    </script>
    <style>
      html,
      body {
        background: radial-gradient(
          60% 60% at 50% -10%,
          #1f2a44 0%,
          #0a0f1e 70%
        );
      }
      .ornate {
        box-shadow: inset 0 0 30px rgba(60, 120, 255, 0.15);
        backdrop-filter: blur(6px);
      }
      .skill-tile {
        position: relative;
        transition: box-shadow 0.15s ease, transform 0.06s ease;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 0.5rem;
        overflow: visible !important;
      }
      .skill-tile:hover {
        box-shadow: 0 0 20px rgba(34, 211, 238, 0.3);
        z-index: 10;
      }

      .skill-tooltip {
        position: absolute;
        bottom: calc(100% + 10px);
        left: 50%;
        transform: translateX(-50%) scale(0.95);
        width: 280px;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(56, 189, 248, 0.3);
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(8px);
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: all 0.2s ease;
        transform-origin: bottom center;
        will-change: transform, opacity;
        text-align: center;
      }
      
      /* Position tooltip for loadout skills */
      .loadout-active .skill-tooltip,
      .loadout-passive .skill-tooltip,
      .loadout-stigma .skill-tooltip {
        bottom: calc(100% + 10px);
        top: auto;
        left: 50%;
        transform: translateX(-50%) scale(0.95);
        transform-origin: bottom center;
      }
      
      .loadout-active .skill-tooltip::after,
      .loadout-passive .skill-tooltip::after,
      .loadout-stigma .skill-tooltip::after {
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border-width: 8px;
        border-style: solid;
        border-color: rgba(15, 23, 42, 0.95) transparent transparent transparent;
      }

      .skill-tile:hover .skill-tooltip {
        opacity: 1;
        transform: translateX(-50%) scale(1) translateY(-5px);
        visibility: visible;
      }
      
      .loadout-active:hover .skill-tooltip,
      .loadout-passive:hover .skill-tooltip,
      .loadout-stigma:hover .skill-tooltip {
        opacity: 1;
        transform: translateX(-50%) scale(1) translateY(5px);
        visibility: visible;
      }

      .skill-tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border-width: 8px;
        border-style: solid;
        border-color: rgba(15, 23, 42, 0.95) transparent transparent transparent;
      }

      .skill-tooltip-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 8px;
        margin-bottom: 8px;
        border-bottom: 1px solid rgba(56, 189, 248, 0.2);
      }

      .skill-tooltip-name {
        font-weight: 600;
        color: #e2e8f0;
        font-size: 1.1em;
      }

      .skill-tooltip-type {
        font-size: 0.8em;
        background: rgba(56, 189, 248, 0.2);
        color: #7dd3fc;
        padding: 2px 8px;
        border-radius: 10px;
        text-transform: capitalize;
      }

      .skill-tooltip-level {
        font-size: 0.9em;
        color: #94a3b8;
        margin-bottom: 8px;
      }

      .skill-tooltip-desc {
        font-size: 0.9em;
        line-height: 1.5;
        color: #cbd5e1;
      }

      .skill-tooltip-level-bar {
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        margin: 8px 0;
        overflow: hidden;
      }

      .skill-tooltip-level-fill {
        height: 100%;
        background: linear-gradient(90deg, #38bdf8, #0ea5e9);
        transition: width 0.3s ease;
      }
      .skill-tile:active {
        transform: scale(0.98);
      }
      .skill-tile .skill-icon {
        font-size: 1.5rem;
        margin-bottom: 0.25rem;
      }
      .skill-tile .skill-name {
        font-size: 0.75rem;
        text-align: center;
        line-height: 1.2;
      }
    </style>
  </head>
  <body class="min-h-screen text-slate-100">
    <div class="mx-auto max-w-6xl px-4 py-6 md:py-10">
      <div
        class="mb-6 flex flex-col items-start justify-between gap-3 md:mb-10 md:flex-row md:items-center"
      >
        <div>
          <h1 class="text-2xl font-bold tracking-tight">
            Aion 2 – Skill Builder
          </h1>
        </div>
      </div>

      <div
        class="ornate rounded-2xl border border-slate-700/60 bg-[rgba(8,10,18,0.85)] p-4"
      >
        <div class="mb-3 flex items-center justify-between">
          <h3
            class="text-sm font-semibold uppercase tracking-wide text-slate-200"
          >
            Classes
          </h3>
        </div>
        <div
          id="class-grid"
          class="grid grid-cols-2 gap-2 sm:grid-cols-3 md:grid-cols-4"
        ></div>
        <style>
          .class-name {
            margin-left: -70px;
          }
        </style>
      </div>

      <div
        class="mt-6 ornate rounded-2xl border border-slate-700/60 bg-[rgba(8,10,18,0.85)] p-4 mb-6"
      >
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <label class="text-sm text-slate-300">Character Level:</label>
            <input
              type="number"
              id="character-level"
              min="1"
              max="45"
              value="1"
              class="w-16 px-2 py-1 bg-slate-800 border border-slate-600 rounded text-white text-center"
            />
          </div>
          <div class="flex items-center gap-2">
            <button
              id="btn-max-levels"
              class="rounded-xl border border-amber-500/50 bg-amber-500/10 px-3 py-2 text-sm text-amber-200 hover:bg-amber-500/20"
            >
              Max Skill Levels
            </button>
            <button
              id="btn-reset"
              class="rounded-xl border border-slate-700 bg-[#0d1426] px-3 py-2 text-sm text-slate-200 hover:bg-[#101832]"
            >
              Reset
            </button>
            <button
              id="btn-share"
              class="rounded-xl border border-cyan-400/50 bg-cyan-500/10 px-3 py-2 text-sm text-cyan-200 shadow-[0_0_12px_rgba(34,211,238,0.35)] hover:bg-cyan-500/20"
            >
              Share
            </button>
          </div>
        </div>
      </div>

      <div
        class="ornate rounded-2xl border border-slate-700/60 bg-[rgba(8,10,18,0.85)] p-4"
      >
        <div class="mb-3 flex items-center justify-between">
          <h3
            class="text-sm font-semibold uppercase tracking-wide text-slate-200"
          >
            SKILL LOADOUT
          </h3>
          <div class="flex items-center space-x-2">
            <span class="text-xs text-cyan-400">Active</span>
            <span class="text-xs text-emerald-400">Passive</span>
            <span class="text-xs text-purple-400">Stigma</span>
          </div>
        </div>

        <div class="w-full px-2">
          <div class="flex items-center justify-between">
            <!-- Active Skills (4) -->
            <div class="flex space-x-3 flex-1 justify-center">
              <div
                class="loadout-active h-[4.5rem] w-[4.5rem] rounded-xl border-2 border-cyan-500/40 bg-[#0b1120] shadow-[inset_0_0_16px_rgba(34,211,238,0.15)]"
                data-skill-id=""
              ></div>
              <div
                class="loadout-active h-[4.5rem] w-[4.5rem] rounded-xl border-2 border-cyan-500/40 bg-[#0b1120] shadow-[inset_0_0_16px_rgba(34,211,238,0.15)]"
                data-skill-id=""
              ></div>
              <div
                class="loadout-active h-[4.5rem] w-[4.5rem] rounded-xl border-2 border-cyan-500/40 bg-[#0b1120] shadow-[inset_0_0_16px_rgba(34,211,238,0.15)]"
                data-skill-id=""
              ></div>
              <div
                class="loadout-active h-[4.5rem] w-[4.5rem] rounded-xl border-2 border-cyan-500/40 bg-[#0b1120] shadow-[inset_0_0_16px_rgba(34,211,238,0.15)]"
                data-skill-id=""
              ></div>
            </div>

            <!-- Vertical Divider -->
            <div class="h-14 w-0.5 bg-slate-700/60 mx-1"></div>

            <!-- Passive Skills (4) -->
            <div class="flex space-x-3 flex-1 justify-center">
              <div
                class="loadout-passive h-[4.5rem] w-[4.5rem] rounded-xl border-2 border-emerald-500/40 bg-[#0b1120] shadow-[inset_0_0_16px_rgba(16,185,129,0.15)]"
                data-skill-id=""
              ></div>
              <div
                class="loadout-passive h-[4.5rem] w-[4.5rem] rounded-xl border-2 border-emerald-500/40 bg-[#0b1120] shadow-[inset_0_0_16px_rgba(16,185,129,0.15)]"
                data-skill-id=""
              ></div>
              <div
                class="loadout-passive h-[4.5rem] w-[4.5rem] rounded-xl border-2 border-emerald-500/40 bg-[#0b1120] shadow-[inset_0_0_16px_rgba(16,185,129,0.15)]"
                data-skill-id=""
              ></div>
              <div
                class="loadout-passive h-[4.5rem] w-[4.5rem] rounded-xl border-2 border-emerald-500/40 bg-[#0b1120] shadow-[inset_0_0_16px_rgba(16,185,129,0.15)]"
                data-skill-id=""
              ></div>
            </div>

            <!-- Vertical Divider -->
            <div class="h-14 w-0.5 bg-slate-700/60 mx-1"></div>

            <!-- Stigma Skills (4) -->
            <div class="flex space-x-3 flex-1 justify-center">
              <div
                class="loadout-stigma h-[4.5rem] w-[4.5rem] rounded-xl border-2 border-purple-500/40 bg-[#0b1120] shadow-[inset_0_0_16px_rgba(168,85,247,0.15)]"
                data-skill-id=""
              ></div>
              <div
                class="loadout-stigma h-[4.5rem] w-[4.5rem] rounded-xl border-2 border-purple-500/40 bg-[#0b1120] shadow-[inset_0_0_16px_rgba(168,85,247,0.15)]"
                data-skill-id=""
              ></div>
              <div
                class="loadout-stigma h-[4.5rem] w-[4.5rem] rounded-xl border-2 border-purple-500/40 bg-[#0b1120] shadow-[inset_0_0_16px_rgba(168,85,247,0.15)]"
                data-skill-id=""
              ></div>
              <div
                class="loadout-stigma h-[4.5rem] w-[4.5rem] rounded-xl border-2 border-purple-500/40 bg-[#0b1120] shadow-[inset_0_0_16px_rgba(168,85,247,0.15)]"
                data-skill-id=""
              ></div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-6">
        <div
          class="ornate rounded-2xl border border-slate-700/60 bg-[rgba(8,10,18,0.85)] p-4"
        >
          <div class="mb-3 flex items-center justify-between">
            <h3
              class="text-sm font-semibold uppercase tracking-wide text-slate-200"
            >
              Active Skills
            </h3>
            <span
              id="count-active"
              class="rounded-md border border-cyan-400/40 bg-cyan-500/10 px-1.5 py-0.5 text-[10px] font-semibold text-cyan-200 shadow-[0_0_10px_rgba(34,211,238,0.35)]"
              >0</span
            >
          </div>
          <div
            id="grid-active"
            class="grid grid-cols-4 gap-3 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8"
          ></div>
        </div>
      </div>

      <div class="mt-6">
        <div
          class="ornate rounded-2xl border border-slate-700/60 bg-[rgba(8,10,18,0.85)] p-4"
        >
          <div class="mb-3 flex items-center justify-between">
            <h3
              class="text-sm font-semibold uppercase tracking-wide text-slate-200"
            >
              Passive Skills
            </h3>
            <span
              id="count-passive"
              class="rounded-md border border-cyan-400/40 bg-cyan-500/10 px-1.5 py-0.5 text-[10px] font-semibold text-cyan-200 shadow-[0_0_10px_rgba(34,211,238,0.35)]"
              >0</span
            >
          </div>
          <div
            id="grid-passive"
            class="grid grid-cols-4 gap-3 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8"
          ></div>
        </div>
      </div>

      <div class="mt-6">
        <div
          class="ornate rounded-2xl border border-slate-700/60 bg-[rgba(8,10,18,0.85)] p-4"
        >
          <div class="mb-3 flex items-center justify-between">
            <h3
              class="text-sm font-semibold uppercase tracking-wide text-slate-200"
            >
              Stigma Skills
            </h3>
            <span
              id="count-stigma"
              class="rounded-md border border-purple-400/40 bg-purple-500/10 px-1.5 py-0.5 text-[10px] font-semibold text-purple-200 shadow-[0_0_10px_rgba(168,85,247,0.35)]"
              >0</span
            >
          </div>
          <div
            id="grid-stigma"
            class="grid grid-cols-4 gap-3 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8"
          ></div>
        </div>
      </div>

      <div class="mt-8 text-center text-xs text-slate-400">
        Left-Click to add to loadout • Right-Click to cycle levels
      </div>
    </div>

    <script>
      // ---------- Class Icon Helper ----------
      function classIcon(iconNumber, label, selected) {
        const img = document.createElement("img");
        img.setAttribute("aria-label", label || "");
        img.className =
          "inline-block h-52 w-52 object-contain -ml-6 -mt-4 -mb-4";
        img.src = `Class-icons/class-icon-${iconNumber}-hover.webp`;
        img.alt = label || "";

        // Apply different styles based on selection
        if (selected) {
          // Selected state: slight glow
          img.style.filter = "drop-shadow(0 0 6px rgba(255,255,255,.3))";
        } else {
          // Non-selected state: reduce brightness and saturation
          img.style.filter =
            "brightness(0.8) saturate(0.85) drop-shadow(0 0 2px rgba(0,0,0,0.2))";
          // Add smooth transition for hover effects
          img.style.transition = "filter 0.2s ease";

          // Add hover effect to slightly brighten on mouseover
          img.addEventListener("mouseover", () => {
            img.style.filter =
              "brightness(0.85) saturate(0.9) drop-shadow(0 0 4px rgba(0,0,0,0.3))";
          });
          img.addEventListener("mouseout", () => {
            img.style.filter =
              "brightness(0.8) saturate(0.85) drop-shadow(0 0 2px rgba(0,0,0,0.2))";
          });
        }
        return img;
      }

      // Skill icons are now loaded from the Skill-icons folder

      // ---------- Data ----------
      const CLASSES = [
        { id: "gladiator", name: "Gladiator", kr: "검성", icon: 1 },
        { id: "templar", name: "Templar", kr: "수호성", icon: 2 },
        { id: "assassin", name: "Assassin", kr: "살성", icon: 3 },
        { id: "ranger", name: "Ranger", kr: "궁성", icon: 4 },
        { id: "chanter", name: "Chanter", kr: "호법성", icon: 5 },
        { id: "cleric", name: "Cleric", kr: "치유성", icon: 6 },
        { id: "sorcerer", name: "Sorcerer", kr: "마도성", icon: 7 },
        { id: "spiritmaster", name: "Spiritmaster", kr: "정령성", icon: 8 },
      ];

      function encodeBuild(obj) {
        return Object.entries(obj)
          .filter(([k, v]) => v >= 1) // Changed from > 0 to >= 1 since 1 is now minimum
          .map(([k, v]) => `${k}:${v}`)
          .join(",");
      }
      function decodeBuild(q) {
        if (!q) return {};
        return q.split(",").reduce((a, p) => {
          const [k, v] = p.split(":");
          if (k && v) a[k] = Number(v);
          return a;
        }, {});
      }

      let selectedClassId = CLASSES[0].id; // default: Gladiator
      let build = (() => {
        const params = new URLSearchParams(location.search);
        return decodeBuild(params.get("build"));
      })();

      const classGrid = document.getElementById("class-grid");
      const gridActive = document.getElementById("grid-active");
      const gridPassive = document.getElementById("grid-passive");
      const gridStigma = document.getElementById("grid-stigma");
      const countActive = document.getElementById("count-active");
      const countPassive = document.getElementById("count-passive");
      const countStigma = document.getElementById("count-stigma");

      function renderClasses() {
        classGrid.innerHTML = "";
        CLASSES.forEach((c) => {
          const btn = document.createElement("button");
          btn.className = [
            "flex items-center gap-2 rounded-xl border p-2 text-left transition h-full w-full overflow-visible",
            selectedClassId === c.id
              ? "border-cyan-400/60 bg-cyan-500/10 text-cyan-100 shadow-[0_0_15px_rgba(34,211,238,0.35)]"
              : "border-slate-700 bg-[#0b1120] text-slate-200 hover:bg-[#0d1426]",
          ].join(" ");
          const iconWrap = document.createElement("div");
          iconWrap.className = `flex-shrink-0 ml-[-0px] ${
            selectedClassId === c.id ? "text-cyan-200" : "text-slate-300"
          }`;
          iconWrap.appendChild(
            classIcon(c.icon, c.name, selectedClassId === c.id)
          );
          const className = document.createElement("div");
          className.className = `text-center text-lg font-semibold mt-1 text-slate-300 class-name`;
          className.textContent = c.name;
          const labels = document.createElement("div");
          labels.className = "flex-1 text-center";
          labels.appendChild(className);
          btn.append(iconWrap, labels);
          btn.addEventListener("click", () => {
            if (selectedClassId === c.id) return; // No change if clicking the same class

            // Reset the build for the new class
            build = {};

            // Clear loadout slots
            document
              .querySelectorAll(
                ".loadout-active, .loadout-passive, .loadout-stigma"
              )
              .forEach((slot) => {
                slot.innerHTML = "";
                slot.setAttribute("data-skill-id", "");
                slot.classList.remove("bg-opacity-20");
              });

            // Update the selected class
            selectedClassId = c.id;

            // Update URL to remove any build parameters for the previous class
            history.replaceState(null, "", window.location.pathname);

            // Re-render everything
            render();
          });
          classGrid.appendChild(btn);
        });
      }

      function tile(skill) {
        const level = build[skill.id] || 1;
        const pct = skill.maxLevel ? level / skill.maxLevel : 0;
        const btn = document.createElement("button");

        // Check if skill is in any loadout slot
        const isInLoadout =
          Array.from(document.querySelectorAll(`[data-skill-id="${skill.id}"]`))
            .length > 0;

        btn.className = [
          "skill-tile group relative aspect-square w-full overflow-hidden rounded-xl border",
          level > 0 ? "border-cyan-400/60" : "border-slate-700",
          isInLoadout
            ? "ring-2 ring-yellow-400 ring-offset-2 ring-offset-slate-900"
            : "",
          "bg-gradient-to-br from-[#0b1120] to-[#0a0f1e]",
        ].join(" ");

        // For skills with maxLevel 1, show Lv.1/1 instead of Lv.1/undefined
        const maxLevelDisplay =
          skill.maxLevel === undefined ? "1" : skill.maxLevel;

        // Remove title attribute as we're using custom tooltips now
        btn.title = "";

        // Use the skill's ID to construct the image path
        const skillImagePath = `Skill-icons/${skill.id}.png`;

        // Create the tooltip HTML
        const tooltipHTML = createSkillTooltip(skill, level);

        // Set the button's HTML, including the tooltip
        btn.innerHTML = `
          <div class="absolute inset-0 flex flex-col p-1">
            <!-- Icon container -->
            <div class="w-full flex-1 flex items-start justify-start pl-4" style="margin-top: 7px;">
              <div class="w-4/5 aspect-square max-w-[80px] bg-slate-800/50 rounded-md flex items-center justify-center" 
                   style="background-image: url('${skillImagePath}'); background-size: contain; background-repeat: no-repeat;">
              </div>
            </div>
          </div>
          <!-- Text container - positioned absolutely to move independently -->
          <div class="absolute bottom-3 left-0 right-0 text-center px-1">
            <div class="text-xs font-medium text-slate-200 truncate">${
              skill.name
            }</div>
          </div>
          <div class="absolute inset-x-0 bottom-0 h-1 bg-slate-800">
            <div class="h-full bg-cyan-400 transition-all" style="width:${
              pct * 100
            }%"></div>
          </div>
          <div class="absolute right-0.5 top-0 z-10">
            <span class="rounded-md border border-cyan-400/40 bg-cyan-500/10 px-1 py-0.5 text-[10px] font-semibold text-cyan-200 shadow-[0_0_10px_rgba(34,211,238,0.35)]">Lv.${level}</span>
          </div>
          ${
            isInLoadout
              ? '<div class="absolute left-1 top-1 text-yellow-400">★</div>'
              : ""
          }
          <!-- Tooltip container -->
          ${tooltipHTML}
        `;

        // Preload the image and handle loading errors
        const img = new Image();
        img.onload = function () {
          // Image loaded successfully - the background-image in the HTML will show it
          console.log(`Skill icon loaded: ${skillImagePath}`);
        };
        img.onerror = function () {
          // Image failed to load - show fallback text
          console.warn(`Skill icon not found: ${skillImagePath}`);
          const skillDiv = btn.querySelector(".absolute.inset-0 div");
          if (skillDiv) {
            skillDiv.style.backgroundImage = "none";
            skillDiv.classList.remove("bg-cover", "bg-center");
          }
        };
        img.src = skillImagePath;

        // Right click to cycle through skill levels
        btn.addEventListener("mousedown", (e) => {
          if (e.button === 2) {
            // Right mouse button
            e.preventDefault(); // Prevent context menu
            const currentLevel = build[skill.id] || 1;
            const maxLevel = skill.levels ? skill.levels.length : 0;
            const newLevel = currentLevel < maxLevel ? currentLevel + 1 : 1;
            
            // Update the skill level in the build
            build[skill.id] = newLevel;

            // If the skill is in the loadout, update its display
            const loadoutSlots = document.querySelectorAll(`[data-skill-id="${skill.id}"]`);
            loadoutSlots.forEach(loadoutSlot => {
              // Update the tooltip to show the new level
              const tooltipHTML = createSkillTooltip(skill, newLevel);
              const tooltipContainer = loadoutSlot.querySelector('.skill-tooltip');
              if (tooltipContainer) {
                tooltipContainer.outerHTML = tooltipHTML;
              }
              
              // Update the title attribute for the loadout slot
              loadoutSlot.title = `${skill.name} (Lv.${newLevel})`;
            });

            // Update the skill display
            render();
            return false;
          }
        });

        // Prevent context menu on right-click
        btn.oncontextmenu = () => false;

        // Left click to add/remove from loadout
        btn.addEventListener("click", (e) => {
          if (e.button === 0) {
            // Left click only
            const skillType = skill.type; // 'active', 'passive', or 'stigma'
            const loadoutSlots = document.querySelectorAll(
              `.loadout-${skillType}`
            );

            // Check if skill is already in loadout
            const existingSlot = Array.from(loadoutSlots).find(
              (slot) => slot.dataset.skillId === skill.id
            );

            if (existingSlot) {
              // Remove from loadout
              existingSlot.innerHTML = "";
              existingSlot.dataset.skillId = "";
              existingSlot.title = "";
            } else {
              // Find first empty slot
              const emptySlot = Array.from(loadoutSlots).find(
                (slot) => !slot.dataset.skillId
              );

              if (emptySlot) {
                // Add to loadout - show the actual skill icon with tooltip
                const skillImagePath = `Skill-icons/${skill.id}.png`;
                emptySlot.innerHTML = `
                  <div class="h-full w-full flex flex-col items-center justify-center p-1 relative group">
                    <div class="w-10 h-10 bg-slate-800/50 rounded-md flex items-center justify-center bg-cover bg-center" 
                         style="background-image: url('${skillImagePath}'); background-size: contain; background-repeat: no-repeat;">
                    </div>
                    <div class="text-xs mt-1 text-center truncate w-full">${skill.name}</div>
                    ${createSkillTooltip(skill, level)}
                  </div>
                `;

                // Preload the image
                const img = new Image();
                img.src = skillImagePath;
                emptySlot.dataset.skillId = skill.id;
                emptySlot.title = `${skill.name} (Lv.${level})`;
              }
            }

            // Re-render to update visual feedback
            render();
          }
        });

        return btn;
      }

      function renderSkills() {
        console.log("CLASS_SKILLS available:", CLASS_SKILLS);
        console.log("selectedClassId:", selectedClassId);

        const skills = CLASS_SKILLS[selectedClassId] || [];
        console.log("Skills for selected class:", skills);

        // Rest of your existing renderSkills code...
        const active = skills.filter((s) => s.type === "active");
        const passive = skills.filter((s) => s.type === "passive");
        const stigma = skills.filter((s) => s.type === "stigma");

        gridActive.innerHTML = "";
        active.forEach((s) => gridActive.appendChild(tile(s)));
        gridPassive.innerHTML = "";
        passive.forEach((s) => gridPassive.appendChild(tile(s)));
        gridStigma.innerHTML = "";
        stigma.forEach((s) => gridStigma.appendChild(tile(s)));
        countActive.textContent = active.length;
        countPassive.textContent = passive.length;
        countStigma.textContent = stigma.length;
      }

      function render() {
        renderClasses();
        renderSkills();
      }

      // Function to update loadout tooltips with current skill levels
      function updateLoadoutTooltips() {
        const loadoutSlots = document.querySelectorAll('[data-skill-id]');
        loadoutSlots.forEach(slot => {
          const skillId = slot.dataset.skillId;
          if (!skillId) return;
          
          // Find the skill data
          const skills = CLASS_SKILLS[selectedClassId] || [];
          const skill = skills.find(s => s.id === skillId);
          if (!skill) return;
          
          // Get current level from build
          const level = build[skillId] || 1;
          
          // Update the tooltip
          const tooltipHTML = createSkillTooltip(skill, level);
          const tooltipContainer = slot.querySelector('.skill-tooltip');
          if (tooltipContainer) {
            tooltipContainer.outerHTML = tooltipHTML;
          }
          
          // Update the title
          slot.title = `${skill.name} (Lv.${level})`;
        });
      }

      // Add event listener for Max Levels button
      document
        .getElementById("btn-max-levels")
        .addEventListener("click", () => {
          // Get all skills for the current class
          const skills = CLASS_SKILLS[selectedClassId] || [];

          // Set all skills to their maximum level
          skills.forEach((skill) => {
            if (skill.type === "active" || skill.type === "passive") {
              build[skill.id] = skill.maxLevel || 1;
            } else if (skill.type === "stigma") {
              build[skill.id] = 1; // Stigma skills typically have max level 1
            }
          });

          // Update the character level to max (45)
          document.getElementById("character-level").value = 45;

          // Update all loadout tooltips
          updateLoadoutTooltips();
          
          // Re-render the skills to reflect the changes
          render();
        });

      document.getElementById("btn-reset").addEventListener("click", () => {
        // Reset build and clear URL parameters
        build = {};
        // Reset character level to 1
        document.getElementById("character-level").value = 1;
        history.replaceState(null, "", window.location.pathname);

        // Reset all skill levels to 0
        document.querySelectorAll(".skill-tile").forEach((tile) => {
          tile.setAttribute("data-level", "0");
          tile.classList.remove("ring-2", "ring-cyan-400");
          const levelBadge = tile.querySelector(".level-badge");
          if (levelBadge) {
            levelBadge.textContent = "";
          }
        });

        // Clear loadout slots
        document
          .querySelectorAll(
            ".loadout-active, .loadout-passive, .loadout-stigma"
          )
          .forEach((slot) => {
            slot.innerHTML = "";
            slot.setAttribute("data-skill-id", "");
            slot.classList.remove("bg-opacity-20");
          });

        // Reset counters
        document.getElementById("count-active").textContent = "0";
        document.getElementById("count-passive").textContent = "0";
        document.getElementById("count-stigma").textContent = "0";

        // Re-render skills to ensure UI is in sync
        renderSkills();
      });
      document.getElementById("btn-share").addEventListener("click", () => {
        const q = encodeBuild(build);
        const url = `${location.origin}${
          location.pathname
        }?build=${encodeURIComponent(q)}`;
        navigator.clipboard &&
          navigator.clipboard.writeText(url).catch(() => {});
        alert("Share URL copied to clipboard!\n" + url);
      });

      (function runSelfTests() {
        try {
          const original = { bolt: 3, blink: 1, aegis: 0 };
          const round = decodeBuild(encodeBuild(original));
          console.assert(
            round.bolt === 3 && round.blink === 1 && (round.aegis ?? 0) === 0,
            "encode/decode failed"
          );
          const clampUp = Math.min(3, 5),
            clampDown = Math.max(0, -1);
          console.assert(
            clampUp === 3 && clampDown === 0,
            "clamp logic failed"
          );
          console.assert(
            JSON.stringify(decodeBuild(null)) === JSON.stringify({}),
            "decode empty failed"
          );
          console.assert(
            JSON.stringify(decodeBuild("")) === JSON.stringify({}),
            "decode empty string failed"
          );
          const noisy = decodeBuild("bolt:2,,x:,blink:1");
          console.assert(
            noisy.bolt === 2 && noisy.blink === 1 && noisy.x === undefined,
            "decode robustness failed"
          );
          console.assert(
            encodeBuild({}) === "",
            "encode empty should be empty string"
          );
          const trailing = decodeBuild("bolt:2,");
          console.assert(trailing.bolt === 2, "trailing comma decode failed");
        } catch (e) {
          console.warn("Self-tests error:", e);
        }
      })();

      render();
    </script>
  </body>
</html>
